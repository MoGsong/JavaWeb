package com.gxlq.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import com.gxlq.entity.Authorization;

/**
 * ?????CURD????
 *
 * @author johny
 * ??¨°???
 */
public class AuthorizationDAO extends BaseDAO {
    /**
     * ??????
     *
     * @param authorization ????????????????????»Ç{id=1,name=???}
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public void add(Authorization authorization) throws ClassNotFoundException, SQLException {
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt =
                conn.prepareStatement("insert into authorization(role,menu) values(?,?)");
        //?????¦Ë?????,???????????????
        pstmt.setInt(1, authorization.getRole().getId());
        pstmt.setInt(2, authorization.getMenu().getId());
        //???SQL???,??????????mysql????
        pstmt.executeUpdate();
        //????????????
        super.closeConnection(conn);
    }

    /**
     * ??????
     *
     * @param authorization ???????????????????»Ç{id=3,name=????}
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public void merge(Authorization authorization) throws ClassNotFoundException, SQLException {
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt =
                conn.prepareStatement("update authorization set role=?,menu=? where id=?");
        //?????¦Ë?????,???????????????
        pstmt.setInt(2, authorization.getRole().getId());
        pstmt.setInt(3, authorization.getMenu().getId());
        pstmt.setInt(1, authorization.getId());
        //???SQL???,??????????mysql????
        pstmt.executeUpdate();
        //????????????
        super.closeConnection(conn);
    }

    /**
     * ??????
     *
     * @param authorization ???????????????????»Ç{id=3,name=????}
     * @throws SQLException
     * @throws ClassNotFoundException
     */
    public void delete(Authorization authorization) throws ClassNotFoundException, SQLException {
        //1?????????? 2??????rbacpro?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt =
                conn.prepareStatement("delete from authorization where id=?");
        //?????¦Ë?????,???????????????
        pstmt.setInt(1, authorization.getId());
        //???SQL???,??????????mysql????
        pstmt.executeUpdate();
        //????????????
        super.closeConnection(conn);
    }
    //??????

    /**
     * ????????????????
     *
     * @return ???????§Ö????§Þ?????????authorization???????????????
     * @throws ClassNotFoundException
     * @throws SQLException
     */
    public Authorization[] findAll() throws ClassNotFoundException, SQLException {
        //????????
        Authorization[] authorizations = new Authorization[findTotal()]; //???????????null
        int i = 0;
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select * from authorization");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        ResultSet rs = pstmt.executeQuery();

        //???????????????
        while (rs.next()) {
            //??????¦²???????¦Ë???????????????
			/*
			int id = rs.getInt("id");  //id???????? 
			String name = rs.getString("name"); //name????????
			Authorization authorization = new Authorization(id, name); //??????????Authorization??????
			authorizations[i] = authorization;
			i++;
			*/
            authorizations[i++] = new Authorization(rs.getInt("id"), new RoleDAO().findByPrimaryKey(rs.getInt("role")), new MenuDAO().findByPrimaryKey(rs.getInt("menu")));
        }
        //????????????
        super.closeConnection(conn);
        //????????
        return authorizations;
    }

    /**
     * ???????????ùb??
     *
     * @return ???????§Ö????§Þ?????????authorization???????????????
     * @throws ClassNotFoundException
     * @throws SQLException
     */
    public Authorization findByPrimaryKey(int ID) throws ClassNotFoundException, SQLException {
        Authorization authorization = new Authorization();
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select * from authorization where id=?");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        pstmt.setInt(1, ID);
        ResultSet rs = pstmt.executeQuery();

        //?????????????????????????????????????????????????????¦Ì???
        if (rs.next()) {
            //??????¦²???????¦Ë???????????????

            authorization = new Authorization(rs.getInt("id"), new RoleDAO().findByPrimaryKey(rs.getInt("role")), new MenuDAO().findByPrimaryKey(rs.getInt("menu"))); //??????????Authorization??????


        }
        //????????????
        super.closeConnection(conn);
        //????????
        return authorization;
    }

    //??????????§Þ????????
    private int findTotal() throws ClassNotFoundException, SQLException {
        int total = 0;
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select  count(*) from authorization");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        ResultSet rs = pstmt.executeQuery();

        //???????????????
        if (rs.next()) {
            //??????¦²???????¦Ë???????????????
            total = rs.getInt(1);  // ???1???????????????? count(*)????????
        }
        //????????????
        super.closeConnection(conn);
        return total;
    }

    private int findTotal(int roleId) throws ClassNotFoundException, SQLException {
        int total = 0;
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select  count(*) from authorization where role=?");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        pstmt.setInt(1,roleId);
        ResultSet rs = pstmt.executeQuery();

        //???????????????
        if (rs.next()) {
            //??????¦²???????¦Ë???????????????
            total = rs.getInt(1);  // ???1???????????????? count(*)????????
        }
        //????????????
        super.closeConnection(conn);
        return total;
    }

    public Authorization[] findAll(int roleId) throws ClassNotFoundException, SQLException {
        //????????
        Authorization[] authorizations = new Authorization[findTotal(roleId)]; //???????????null
        int i = 0;
        //1?????????? 2??????rbac?????
        Connection conn = super.getConnection();
        //3?????????????????? java.sql.Connection,????????????????java.sql.PreparedStatement????????SQL???
        //????????????¦Ë???????¡À??1???????????????????????
        PreparedStatement pstmt = conn.prepareStatement("select * from authorization where role=?");
        //4?????????????????java.sql.PreparedStatement???????????????????java.sql.ResultSet
        pstmt.setInt(1,roleId);
        ResultSet rs = pstmt.executeQuery();

        //???????????????
        while (rs.next()) {
            //??????¦²???????¦Ë???????????????
			/*
			int id = rs.getInt("id");  //id????????
			String name = rs.getString("name"); //name????????
			Authorization authorization = new Authorization(id, name); //??????????Authorization??????
			authorizations[i] = authorization;
			i++;
			*/
            authorizations[i++] = new Authorization(rs.getInt("id"), new RoleDAO().findByPrimaryKey(rs.getInt("role")), new MenuDAO().findByPrimaryKey(rs.getInt("menu")));
        }
        //????????????
        super.closeConnection(conn);
        //????????
        return authorizations;
    }


}
